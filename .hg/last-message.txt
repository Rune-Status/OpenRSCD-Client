More refactoring, some bugfixes probably.